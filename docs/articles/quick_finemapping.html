<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>finemappeR Tutorial • finemappeR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="finemappeR Tutorial">
<meta property="og:description" content="finemappeR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">finemappeR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/quick_finemapping.html">finemappeR Tutorial</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>finemappeR Tutorial</h1>
                        <h4 class="author">Alan Selewa</h4>
            
      
      
      <div class="hidden name"><code>quick_finemapping.Rmd</code></div>

    </div>

    
    
<p>Welcome to this tutorial where we perform finemapping on a small GWAS dataset that is included with this package. Try to reproduce this analysis to ensure everything is installed properly.</p>
<p>We begin by attaching our <code>bigsnpr</code> object. This is our reference panel of genotypes which we use to compute LD between SNPs. If you are in the He lab, you can just use the following chunk. Otherwise, you will need to obtain your own genotypes in PLINK format (bed/bim/fam) and use <code>bigsnpr::readBed()</code> to create the <code>.rds</code> file below.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">bigSNP</span> <span class="kw">&lt;-</span> <span class="kw pkg">bigsnpr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigsnpr/man/snp_attach.html">snp_attach</a></span>(<span class="kw">rdsfile</span> <span class="kw">=</span> <span class="st">'/project2/xinhe/1kg/bigsnpr/EUR_variable_1kg.rds'</span>)</pre></body></html></div>
<p>Here we show a quick run-through of <code>finemappeR</code> using a test summary statistics.</p>
<p>First we run <code><a href="../reference/RunCleaner.html">RunCleaner()</a></code>, which takes our summary statistics in either tab or comma delimited. It also takes a character vector of the 8 column names needed. The columns needed have to be given in the following order:</p>
<ul>
<li>chromosome (just the number, no “chr”, hg19!)<br>
</li>
<li>position (base pair position, hg19!)<br>
</li>
<li>beta (if you have Odds Ratio, you will need to transform it to log(Odds Ratio))<br>
</li>
<li>standard error (SE)<br>
</li>
<li>reference allele (A,C,T,G)<br>
</li>
<li>association/effect allele (A,C,T,G)<br>
</li>
<li>some kind of SNP ID (rsID, or chr:position:a1:a2)<br>
</li>
<li>p-value</li>
</ul>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">finemappeR</span>)

<span class="no">fpath</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"test_sumstats.txt.gz"</span>, <span class="kw">package</span><span class="kw">=</span><span class="st">"finemappeR"</span>)
<span class="no">gwas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/RunCleaner.html">RunCleaner</a></span>(<span class="kw">sumstats</span> <span class="kw">=</span> <span class="no">fpath</span>,
                   <span class="kw">ColsToKeep</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'chr'</span>,<span class="st">'position_b37'</span>,<span class="st">'bcac_onco2_beta'</span>,<span class="st">'bcac_onco2_se'</span>,<span class="st">'a0'</span>,<span class="st">'a1'</span>,<span class="st">'phase3_1kg_id'</span>,<span class="st">'bcac_onco2_P1df_Wald'</span>),
                   <span class="kw">bigSNP</span> <span class="kw">=</span> <span class="no">bigSNP</span>)</pre></body></html></div>
<pre><code>## [1] "Loading summary statistics..."</code></pre>
<pre><code>## Observations: 9,999
## Variables: 14
## chr [5]: var_name, phase3_1kg_id, a0, a1, rsIDs
## dbl [9]: chr, position_b37, bcac_onco2_r2, bcac_onco2_eaf_controls, bcac_onco2_beta...
## 
## Call `spec()` for a copy-pastable column specification
## Specify the column types with `col_types` to quiet this message</code></pre>
<pre><code>## [1] "Cleaning summary statistics.."
## [1] "Matching to reference panel..."</code></pre>
<pre><code>## 8,961 variants to be matched.</code></pre>
<pre><code>## 1,255 ambiguous SNPs have been removed.</code></pre>
<pre><code>## 7,600 variants have been matched; 0 were flipped and 6,374 were reversed.</code></pre>
<pre><code>## [1] "Assining SNPs to LD blocks..."
## [1] "Complete."</code></pre>
<p>Check that the output is cleaned and has appropriate columns:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">gwas</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'chr'</span>,<span class="st">'pos'</span>,<span class="st">'beta'</span>,<span class="st">'se'</span>,<span class="st">'snp'</span>,<span class="st">'pval'</span>,<span class="st">'zscore'</span>)]</pre></body></html></div>
<pre><code>## # A tibble: 7,600 x 7
##      chr   pos     beta     se snp                       pval   zscore
##    &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;                    &lt;dbl&gt;    &lt;dbl&gt;
##  1     1 13110 -0.0207  0.0323 1:13110:G:A           0.522    -0.639  
##  2     1 13116 -0.0126  0.0190 rs201725126:13116:T:G 0.508    -0.662  
##  3     1 13118 -0.0126  0.0190 rs200579949:13118:A:G 0.508    -0.662  
##  4     1 13550  0.132   0.112  1:13550:G:A           0.241     1.17   
##  5     1 14604  0.0222  0.0186 1:14604:A:G           0.233     1.19   
##  6     1 14930  0.00247 0.0141 rs75454623:14930:A:G  0.860     0.176  
##  7     1 14933 -0.0199  0.0388 rs199856693:14933:G:A 0.607    -0.514  
##  8     1 15211  0.00002 0.0162 rs78601809:15211:T:G  0.999     0.00123
##  9     1 15644  0.364   0.104  1:15644:G:A           0.000484  3.49   
## 10     1 15774  0.265   0.0935 rs374029747:15774:G:A 0.00463   2.83   
## # ... with 7,590 more rows</code></pre>
<p>Next, we must perform enrichment analysis with TORUS, which requires annotation files in <code>.bed</code> format. Use the <code><a href="../reference/PrepareTorusFiles.html">PrepareTorusFiles()</a></code> function, which takes the previous output, and a directory with bed files. Your bed file should contain only 3 columns (chr, start, end) and chromosomes should be just the number (no “chr”). Currently only hg19/b37 coordinates are accepted. You will get wrong results if you use hg38/other.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">bed_annotations</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"test_bed_dir/"</span>, <span class="kw">package</span><span class="kw">=</span><span class="st">"finemappeR"</span>)
<span class="no">torus.files</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/PrepareTorusFiles.html">PrepareTorusFiles</a></span>(<span class="no">gwas</span>, <span class="kw">bed_annotations</span> <span class="kw">=</span> <span class="no">bed_annotations</span>)</pre></body></html></div>
<pre><code>## [1] "Annotating Snps.."
## [1] "Writing files to temporary location.."
## [1] "Done."</code></pre>
<p>Now that the appropriate files have been generated (they are in .temp/), lets run TORUS. <code><a href="../reference/RunTorus.html">RunTorus()</a></code> returns two things: enrichment level of each annotation in log2 units, and the posterior inclusion probability (PIP) of each SNP. These PIPs will be used as priors for finemapping.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">torus.result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/RunTorus.html">RunTorus</a></span>(<span class="kw">torus_annot_file</span> <span class="kw">=</span> <span class="no">torus.files</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="kw">torus_zscore_file</span> <span class="kw">=</span> <span class="no">torus.files</span><span class="kw">[[</span><span class="fl">2</span>]])</pre></body></html></div>
<pre><code>## Running /tmp/Rtmp8OB23t/temp_libpathc39132959580/finemappeR/torus -d \
##   /tmp/RtmpV78IY8/filec81933ed5a96.txt.gz -annot \
##   /tmp/RtmpV78IY8/filec819b0e664c.txt.gz --load_zval -dump_prior prior
## Read in 2 loci, 7600 locus-SNP pairs ... 
## Loading annotations ... 
## Initializing ... 
## Starting EM ... 
##   Iter          loglik          Intercept    testbed.bed.1   testbed2.bed.1  
##    1            -5.143           -9.147      0.404      0.681  
##    2            -0.647          -10.368      0.809      1.100  
##    3            -0.252          -11.365      1.213      1.469  
##    4            -0.128          -12.268      1.618      1.818  
##    5            -0.072          -13.122      2.022      2.156  
## Output priors to directory prior...
## 
##                 Intercept    -13.122       -13.988    -12.256
##             testbed.bed.1      0.002        -1.091      1.094
##            testbed2.bed.1      0.002        -1.076      1.080</code></pre>
<p>TORUS also gives us the uncertainty associated with whether each chunk contains a causal variant or not. We run <code><a href="../reference/RunTorusFDR.html">RunTorusFDR()</a></code> to get the probability of each chunk containing a causal variant. We can filter our chunks with low probability, thus saving us on computational time!</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">torus.fdr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/RunTorusFDR.html">RunTorusFDR</a></span>()</pre></body></html></div>
<pre><code>## Running /tmp/Rtmp8OB23t/temp_libpathc39132959580/finemappeR/torus -d \
##   .temp/torus_zscores.txt.gz -annot .temp/torus_annotations.txt.gz \
##   --load_zval -qtl
## Read in 2 loci, 7600 locus-SNP pairs ... 
## Loading annotations ... 
## Initializing ... 
## Starting EM ... 
##   Iter          loglik          Intercept    testbed.bed.1   testbed2.bed.1  
##    1            -5.143           -9.147      0.404      0.681  
##    2            -0.647          -10.368      0.809      1.100  
##    3            -0.252          -11.365      1.213      1.469  
##    4            -0.128          -12.268      1.618      1.818  
##    5            -0.072          -13.122      2.022      2.156  
## 
## 
##     Total Loci: 2   Rejections: 0
##     1                     1    9.510e-01    0
##     2                     2    9.714e-01    0</code></pre>
<p>Lets add the TORUS results back onto our cleaned summary statistics. <code><a href="../reference/PrepareSusieData.html">PrepareSusieData()</a></code> takes a parameter called <code>fdr_thresh</code> which is the FDR associated with each chunk. This value is 10% by default, and chunks with FDR &lt; 10% are removed. I set it to 1 here just to keep all chunks but you will want to lower this or just use default.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">susie.df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/PrepareSusieData.html">PrepareSusieData</a></span>(<span class="kw">sumstats</span> <span class="kw">=</span> <span class="no">gwas</span>, <span class="kw">torus_pip</span> <span class="kw">=</span> <span class="no">torus.result</span>$<span class="no">snp_pip</span>, <span class="kw">torus_fdr</span> <span class="kw">=</span> <span class="no">torus.fdr</span>, <span class="kw">fdr_thresh</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p>We see we have a new column called <code>torus_pip</code></p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">susie.df</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'chr'</span>,<span class="st">'pos'</span>,<span class="st">'beta'</span>,<span class="st">'se'</span>,<span class="st">'snp'</span>,<span class="st">'pval'</span>,<span class="st">'zscore'</span>,<span class="st">'torus_pip'</span>)]</pre></body></html></div>
<pre><code>## # A tibble: 7,600 x 8
##      chr   pos     beta     se snp                  pval   zscore torus_pip
##    &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
##  1     1 13110 -0.0207  0.0323 1:13110:G:A      0.522    -0.639     2.00e-6
##  2     1 13116 -0.0126  0.0190 rs201725126:131~ 0.508    -0.662     1.51e-5
##  3     1 13118 -0.0126  0.0190 rs200579949:131~ 0.508    -0.662     1.51e-5
##  4     1 13550  0.132   0.112  1:13550:G:A      0.241     1.17      1.51e-5
##  5     1 14604  0.0222  0.0186 1:14604:A:G      0.233     1.19      1.51e-5
##  6     1 14930  0.00247 0.0141 rs75454623:1493~ 0.860     0.176     1.51e-5
##  7     1 14933 -0.0199  0.0388 rs199856693:149~ 0.607    -0.514     1.51e-5
##  8     1 15211  0.00002 0.0162 rs78601809:1521~ 0.999     0.00123   1.51e-5
##  9     1 15644  0.364   0.104  1:15644:G:A      0.000484  3.49      1.51e-5
## 10     1 15774  0.265   0.0935 rs374029747:157~ 0.00463   2.83      1.51e-5
## # ... with 7,590 more rows</code></pre>
<p>With this data frame, we can perform finemapping. We use <code><a href="../reference/RunFinemapping.html">RunFinemapping()</a></code> to get out results. This will be quite slow if chunks contain many SNPs( O(n^2) where n is # of SNPs). I am working on ways to parallize this step (maybe you can help!)</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">susie_finemap_L1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/RunFinemapping.html">RunFinemapping</a></span>(<span class="kw">sumstats</span> <span class="kw">=</span> <span class="no">susie.df</span>, <span class="kw">bigSNP</span> <span class="kw">=</span> <span class="no">bigSNP</span>)</pre></body></html></div>
<pre><code>## [1] "Finemapping chunks.. 1 of 2"
## [1] "Finemapping chunks.. 2 of 2"</code></pre>
<p><code>susie_finemap_L1</code> is a list of SuSiE results, one for each chunk/LD block. Usually we are just interested in the SuSiE PIP, which gives the probability of a SNP being causal. We can annotate our cleaned summary statistics with this information using <code>merge_susie_sumstats()</code></p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">gwas_finemapped</span> <span class="kw">&lt;-</span> <span class="fu">merge_susie_sumstats</span>(<span class="kw">susie_results</span> <span class="kw">=</span> <span class="no">susie_finemap_L1</span>, <span class="kw">sumstats</span> <span class="kw">=</span> <span class="no">susie.df</span>)</pre></body></html></div>
<p>Lets look at the final cleaned, and finemapped summary statistics. We see we have a new column called <code>susie_pip</code> which is the probability of being causal. Note that we ran SuSiE with L = 1 here, meaning we assumed there is at most 1 causal variant per SNP.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">gwas_finemapped</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'chr'</span>,<span class="st">'pos'</span>,<span class="st">'beta'</span>,<span class="st">'se'</span>,<span class="st">'snp'</span>,<span class="st">'pval'</span>,<span class="st">'zscore'</span>,<span class="st">'torus_pip'</span>,<span class="st">'susie_pip'</span>)]</pre></body></html></div>
<pre><code>## # A tibble: 7,600 x 9
##      chr   pos     beta     se snp        pval   zscore torus_pip susie_pip
##    &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1     1 13110 -0.0207  0.0323 1:1311~ 5.22e-1 -0.639     2.00e-6         0
##  2     1 13116 -0.0126  0.0190 rs2017~ 5.08e-1 -0.662     1.51e-5         0
##  3     1 13118 -0.0126  0.0190 rs2005~ 5.08e-1 -0.662     1.51e-5         0
##  4     1 13550  0.132   0.112  1:1355~ 2.41e-1  1.17      1.51e-5         0
##  5     1 14604  0.0222  0.0186 1:1460~ 2.33e-1  1.19      1.51e-5         0
##  6     1 14930  0.00247 0.0141 rs7545~ 8.60e-1  0.176     1.51e-5         0
##  7     1 14933 -0.0199  0.0388 rs1998~ 6.07e-1 -0.514     1.51e-5         0
##  8     1 15211  0.00002 0.0162 rs7860~ 9.99e-1  0.00123   1.51e-5         0
##  9     1 15644  0.364   0.104  1:1564~ 4.84e-4  3.49      1.51e-5         0
## 10     1 15774  0.265   0.0935 rs3740~ 4.63e-3  2.83      1.51e-5         0
## # ... with 7,590 more rows</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alan Selewa.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
